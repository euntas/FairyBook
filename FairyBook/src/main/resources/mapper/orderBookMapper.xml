<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="global.sesoc.fairybook.mapper.OrderBookMapper">
 
<insert id="saveOrder" parameterType="OrderBook">
	insert into 
		orderbook
	values
	(
		#{ordernum}
		,#{selectionnum}
		,sysdate
		,#{bookcover}
		,#{currentstate}
		,#{price}
	)
</insert>

<select id="setOrdernum" resultType="int">
	select
		seq_orderbook.nextval
	from
		dual
</select>

<select id="getOrder" parameterType="Map" resultType="OrderBook">
	select 
		o.ordernum as ordernum
		,o.selectionnum as selectionnum
		,m.id as id
		,o.orderdate as orderdate
		,o.bookcover as bookcover
		,o.currentstate as currentstate
	from
		orderbook o, myselection m
	where
		o.selectionnum = m.selectionnum
	and
	<if test="selectionnum != -1">
		o.selectionnum = #{selectionnum} 
	and 
		o.currentstate not in('addToCart','makeOrder')
	</if>
	<if test="ordernum != -1">
		o.ordernum = #{ordernum} 
	</if>
</select>

<delete id="deleteBookCover" parameterType="int">
	delete from
		orderbook
	where
		ordernum = #{ordernum}
</delete>

<select id="getStoryTitle" parameterType="int" resultType="string">
	select 
		storytitle
	from
		fairytale
	where
		storynum = (
			select 
				storynum 
			from 
				myselection 
			where 
				selectionnum = #{selectionnum}
			)
</select>

<update id="updateOrder" parameterType="OrderBook">
	update
		orderbook
	set
		orderdate=sysdate
		<if test="bookcover != ''">
		,bookcover=#{bookcover}
		</if>
		,currentstate=#{currentstate}
		,price=#{price}
	where
		ordernum=#{ordernum}
</update>

<select id="cartList" parameterType="string" resultType="OrderBook">
	select
		o.ordernum as ordernum
		,o.selectionnum as selectionnum
		,m.id as id
		,o.orderdate as orderdate
		,o.bookcover as bookcover
		,o.currentstate as currentstate
		,o.price as price
	from
		orderbook o, myselection m
	where
		o.selectionnum = m.selectionnum
	and
		m.id = #{id}
</select>

<select id="lastBookCover" parameterType="Map" resultType="integer">
	select
		ordernum
	from 
		orderbook
	where 
		selectionnum in(
			select 
				selectionnum
			from 
				myselection
			where
				storynum=(
					select 
						storynum 
					from 
						myselection 
					where 
						selectionnum = 1
						)
				and 
					id='ryan'
			)
	and 
		bookcover != 'default'
</select>

</mapper>